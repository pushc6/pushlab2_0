# {{ ansible_managed }}
# OAuth2-Proxy Logout Pages Include
# Usage: include {{ nginx_conf_d }}/logout-pages.conf;

# ID Token Hint Logout Endpoints
# Simple logout endpoint
location /logout {
    return 302 /oauth2/sign_out?rd=https://{{ item.ssl_domain }}/logout-success;
}

# SSO logout endpoint with ID token extraction
location /sso-logout {
    # Serve the logout page with embedded JavaScript
    try_files $uri @sso_logout_page;
}

# SSO logout page handler
location @sso_logout_page {
    add_header Content-Type text/html;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
    
    return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Logging Out...</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #f8f9fa; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message { color: #6c757d; margin: 20px 0; }
        .fallback { margin-top: 30px; }
        .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="spinner"></div>
    <div class="message">Logging you out securely...</div>
    <div class="fallback">
        <p>If you are not redirected automatically:</p>
        <a href="/logout" class="btn">Click here to logout</a>
    </div>
    <script>
        (async function() {
            try {
                const userInfoResponse = await fetch("/oauth2/userinfo", {
                    method: "GET",
                    credentials: "include",
                    headers: { 
                        "Accept": "application/json", 
                        "X-Requested-With": "XMLHttpRequest" 
                    }
                });

                if (userInfoResponse.ok) {
                    const userInfo = await userInfoResponse.json();
                    const idToken = userInfo.id_token || userInfo.access_token || userInfo.token;
                    
                    if (idToken) {
                        const keycloakUrl = new URL("https://auth.{{ item.ssl_domain }}/realms/{{ logout_config.keycloak_realm | default("prod") }}/protocol/openid-connect/logout");
                        keycloakUrl.searchParams.set("id_token_hint", idToken);
                        keycloakUrl.searchParams.set("post_logout_redirect_uri", "https://{{ item.ssl_domain }}/logout-success");
                        keycloakUrl.searchParams.set("client_id", "{{ logout_config.keycloak_client_id | default("oauth2-proxy-multi-domain") }}");
                        
                        const oauth2LogoutUrl = "/oauth2/sign_out?rd=" + encodeURIComponent(keycloakUrl.toString());
                        window.location.href = oauth2LogoutUrl;
                        return;
                    }
                }
                
                // Fallback to simple logout
                window.location.href = "/logout";
            } catch (error) {
                console.error("Logout failed:", error);
                window.location.href = "/logout";
            }
        })();
    </script>
</body>
</html>';
}

# Force logout endpoint (bypasses token extraction)
location /force-logout {
    return 302 /oauth2/sign_out?rd=https://auth.{{ item.ssl_domain }}/realms/{{ logout_config.keycloak_realm | default("prod") }}/protocol/openid-connect/logout?client_id={{ logout_config.keycloak_client_id | default("oauth2-proxy-multi-domain") }}&post_logout_redirect_uri=https://{{ item.ssl_domain }}/logout-success;
}
