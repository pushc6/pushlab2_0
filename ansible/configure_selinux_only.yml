---
# configure_selinux_only.yml
# Standalone playbook to configure only SELinux for OAuth2-Proxy
# Usage: ansible-playbook -i inventories/on_premise configure_selinux_only.yml

- name: Configure SELinux for OAuth2-Proxy Backend Services
  hosts: nginx_internal
  become: yes
  remote_user: ansible
  gather_facts: yes

  vars:
    # SELinux configuration options
    selinux_verify_only: false        # Set to true to only check, not configure
    selinux_force_install_tools: false # Force reinstall of SELinux tools

  pre_tasks:
    - name: Verify OAuth2 services are defined
      assert:
        that:
          - oauth2_services is defined
          - oauth2_services | length > 0
        fail_msg: "OAuth2 services not defined. Check group_vars/nginx_internal/oauth2_vars.yml"

    - name: Display SELinux configuration scope
      debug:
        msg:
          - "ğŸ”’ SELinux Configuration for OAuth2-Proxy"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Target host: {{ inventory_hostname }}"
          - "Services to configure: {{ oauth2_services | length }}"
          - "Backend ports: {{ oauth2_services | map(attribute='backend_port') | list | unique | sort }}"
          - "Verify only mode: {{ selinux_verify_only }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  tasks:
    - name: Check SELinux status
      command: getenforce
      register: selinux_status
      changed_when: false
      failed_when: false

    - name: Handle SELinux disabled systems
      block:
        - name: Display SELinux disabled message
          debug:
            msg:
              - "â„¹ï¸  SELinux is disabled on {{ inventory_hostname }}"
              - "No SELinux configuration needed for OAuth2-proxy."
              - "OAuth2-proxy should work without additional configuration."
        
        - name: End play for disabled SELinux
          meta: end_play
          
      when: 
        - selinux_status.rc == 0
        - selinux_status.stdout == "Disabled"

    - name: SELinux verification mode
      block:
        - name: Include SELinux pre-checks only
          include_tasks: roles/oauth2_proxy_nginx/tasks/selinux_pre_checks.yml
          
        - name: Display verification results
          debug:
            msg:
              - "âœ… SELinux verification completed"
              - "Run with selinux_verify_only=false to apply configuration"
              
      when: selinux_verify_only | bool

    - name: SELinux configuration mode  
      block:
        - name: Create filtered services list (all services for SELinux-only run)
          set_fact:
            filtered_oauth2_services: "{{ oauth2_services }}"

        - name: Include SELinux pre-checks
          include_tasks: roles/oauth2_proxy_nginx/tasks/selinux_pre_checks.yml
          
        - name: Include SELinux configuration
          include_tasks: roles/oauth2_proxy_nginx/tasks/selinux_config.yml
          
        - name: Verify nginx configuration if nginx is installed
          block:
            - name: Test nginx configuration syntax
              command: nginx -t
              register: nginx_syntax_test
              changed_when: false
              failed_when: false
              
            - name: Display nginx syntax results
              debug:
                msg: "Nginx configuration: {{ 'Valid âœ…' if nginx_syntax_test.rc == 0 else 'Invalid âŒ' }}"
                
            - name: Reload nginx if running and config is valid
              systemd:
                name: nginx
                state: reloaded
              when: 
                - nginx_syntax_test.rc == 0
                - ansible_facts.services['nginx.service']['state'] == 'running'
                
          when: "'nginx' in ansible_facts.packages"
          
      when: not (selinux_verify_only | bool)

  post_tasks:
    - name: Display final SELinux status
      debug:
        msg:
          - "ğŸ”’ SELinux OAuth2-Proxy Configuration Summary"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Host: {{ inventory_hostname }}"
          - "SELinux Status: {{ selinux_status.stdout }}"
          - "Services configured: {{ oauth2_services | map(attribute='name') | list | join(', ') }}"
          - "Backend ports: {{ oauth2_services | map(attribute='backend_port') | list | unique | sort | join(', ') }}"
          - "Configuration: {{ 'Verified only' if selinux_verify_only else 'Applied' }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "{{ 'âœ… OAuth2-proxy SELinux configuration completed!' if not selinux_verify_only else 'âœ… OAuth2-proxy SELinux verification completed!' }}"
      when: 
        - selinux_status.rc == 0
        - selinux_status.stdout != "Disabled"
