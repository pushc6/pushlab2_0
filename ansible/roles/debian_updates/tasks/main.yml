---
# Debian-specific update tasks
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: "{{ apt_cache_valid_time }}"

- name: Update all packages
  ansible.builtin.apt:
    upgrade: "{{ apt_upgrade_type }}"
    autoclean: "{{ apt_autoclean | bool }}"
    autoremove: "{{ apt_autoremove | bool }}"
  register: apt_update_result
  when: not apt_update_cache_only | bool

- name: Check if reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: reboot_required_file
  when: enable_reboot | bool

- name: Reboot Debian server if needed
  ansible.builtin.reboot:
    msg: "Rebooting due to package updates"
    connect_timeout: 5
    reboot_timeout: "{{ reboot_timeout }}"
    pre_reboot_delay: 0
    post_reboot_delay: "{{ post_reboot_delay }}"
  when:
    - enable_reboot | bool
    - reboot_required_file.stat.exists
