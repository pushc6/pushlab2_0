# {{ ansible_managed }}
# Proxy configuration for: {{ item.description }}
# Service: {{ item.name }} | Domain: {{ item.domain }}
# Proxy Mode: {{ item.proxy_mode | default(proxy_role_config.mode) | upper }}

{% set ssl_config = ssl_certificates[item.ssl_domain] %}
{% set proxy_mode = item.proxy_mode | default(proxy_role_config.mode) %}

server {
    listen 443 ssl http2;
    server_name {{ item.domain }};
    
    # SSL Configuration
    ssl_certificate {{ ssl_config.cert_path }};
    ssl_certificate_key {{ ssl_config.key_path }};
{% if ssl_config.dhparam_path is defined %}
    ssl_dhparam {{ ssl_config.dhparam_path }};
{% endif %}
    ssl_protocols {{ ssl_protocols | default('TLSv1.2 TLSv1.3') }};
    ssl_ciphers {{ ssl_ciphers | default('HIGH:!aNULL:!MD5') }};
    ssl_prefer_server_ciphers {{ ssl_prefer_server_ciphers | default('off') }};
    ssl_session_cache shared:SSL_{{ item.domain | replace('.', '_') | replace('-', '_') }}:10m;
    ssl_session_timeout {{ ssl_session_timeout | default('1d') }};
    ssl_session_tickets {{ ssl_session_tickets | default('off') }};
    
    # SSL Stapling (OCSP)
{% if ssl_stapling_enabled | default(true) %}
    ssl_stapling on;
    ssl_stapling_verify on;
{% if ssl_trusted_certificate is defined %}
    ssl_trusted_certificate {{ ssl_trusted_certificate }};
{% endif %}
    resolver {{ ssl_resolver | default('8.8.8.8 8.8.4.4') }} valid=300s;
    resolver_timeout {{ ssl_resolver_timeout | default('5s') }};
{% endif %}
    
    # Security Headers
    add_header Strict-Transport-Security "max-age={{ hsts_max_age | default('63072000') }}; includeSubDomains{{ '; preload' if hsts_preload | default(false) else '' }}";
    add_header X-Frame-Options {{ x_frame_options | default('DENY') }};
    add_header X-Content-Type-Options {{ x_content_type_options | default('nosniff') }};
    add_header X-XSS-Protection "{{ x_xss_protection | default('1; mode=block') }}";
{% if referrer_policy is defined %}
    add_header Referrer-Policy "{{ referrer_policy }}";
{% endif %}
{% if content_security_policy is defined %}
    add_header Content-Security-Policy "{{ content_security_policy }}";
{% endif %}
    
{% if proxy_mode == 'oauth2' %}
    # ==========================================
    # OAuth2-Proxy Configuration
    # ==========================================
    
    # OAuth2-Proxy includes
    include {{ nginx_conf_d | default('/etc/nginx/conf.d') }}/oauth2-locations.conf;
    
    # ID Token Hint Logout Configuration
    {% if logout_config.enable_id_token_logout | default(true) %}
    include {{ nginx_conf_d | default('/etc/nginx/conf.d') }}/oauth2-logout.conf;
    {% endif %}
{% else %}
    # ==========================================
    # Traditional Proxy Configuration
    # ==========================================
    
    {% if traditional_proxy_config.enable_rate_limiting | default(false) %}
    # Rate limiting
    limit_req zone=proxy_limit burst=20 nodelay;
    {% endif %}
    
    {% if traditional_proxy_config.enable_gzip | default(true) %}
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml application/atom+xml image/svg+xml text/javascript application/x-font-ttf font/opentype;
    {% endif %}
{% endif %}
    
    location / {
{% if proxy_mode == 'oauth2' and item.auth_type != 'none' %}
        # OAuth2 Authentication
        include {{ nginx_conf_d | default('/etc/nginx/conf.d') }}/oauth2-auth-{{ item.auth_type }}.conf;
        
        {% if item.auth_type == 'groups' and item.required_groups is defined %}
        # Group-based access control
        set $access_granted 0;
        {% for group in item.required_groups %}
        if ($http_x_auth_request_groups ~ "{{ group }}") {
            set $access_granted 1;
        }
        {% endfor %}
        if ($access_granted = 0) {
            return 403 "Access denied: Required group membership not found";
        }
        {% endif %}
        
        {% if item.auth_type == 'roles' and item.required_roles is defined %}
        # Role-based access control
        set $access_granted 0;
        {% for role in item.required_roles %}
        if ($http_x_auth_request_groups ~ "{{ role }}") {
            set $access_granted 1;
        }
        {% endfor %}
        if ($access_granted = 0) {
            return 403 "Access denied: Required role not found";
        }
        {% endif %}
{% elif proxy_mode == 'traditional' %}
        # Traditional Proxy (No Authentication)
        {% if item.allowed_ips is defined and item.allowed_ips | length > 0 %}
        # IP-based access control
        {% for ip in item.allowed_ips %}
        allow {{ ip }};
        {% endfor %}
        deny all;
        {% endif %}
        
        {% if traditional_proxy_config.enable_caching | default(false) %}
        # Caching configuration
        proxy_cache proxy_cache_zone;
        proxy_cache_valid 200 302 {{ traditional_proxy_config.cache_valid_time | default('1h') }};
        proxy_cache_valid 404 1m;
        proxy_cache_bypass $http_cache_control;
        add_header X-Cache-Status $upstream_cache_status;
        {% endif %}
{% endif %}
        
        # Proxy to backend service
        proxy_pass http://{{ item.backend_host }}:{{ item.backend_port }};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        proxy_set_header X-Service-Name {{ item.name }};
        proxy_set_header X-Proxy-Mode {{ proxy_mode }};
        
{% if item.custom_headers is defined %}
        # Custom service headers
        {% for header, value in item.custom_headers.items() %}
        proxy_set_header {{ header }} "{{ value }}";
        {% endfor %}
{% endif %}
        
        # Proxy settings
{% if proxy_mode == 'traditional' %}
        proxy_connect_timeout {{ traditional_proxy_config.proxy_timeout | default('60s') }};
        proxy_send_timeout {{ traditional_proxy_config.proxy_timeout | default('60s') }};
        proxy_read_timeout {{ traditional_proxy_config.proxy_timeout | default('60s') }};
        proxy_buffering {{ traditional_proxy_config.proxy_buffering | default('off') }};
        client_max_body_size {{ traditional_proxy_config.client_max_body_size | default('100M') }};
{% else %}
        proxy_connect_timeout {{ nginx_config.proxy_timeout | default(nginx_proxy_timeout | default('60s')) }};
        proxy_send_timeout {{ nginx_config.send_timeout | default(nginx_proxy_timeout | default('60s')) }};
        proxy_read_timeout {{ nginx_config.read_timeout | default(nginx_proxy_timeout | default('60s')) }};
        proxy_buffering {{ nginx_config.proxy_buffering | default('off') }};
        client_max_body_size {{ nginx_config.client_max_body_size | default(nginx_client_max_body_size | default('100M')) }};
{% endif %}
        proxy_redirect off;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Additional security for traditional proxy
{% if proxy_mode == 'traditional' %}
        proxy_hide_header X-Powered-By;
        proxy_hide_header Server;
        proxy_hide_header X-AspNet-Version;
        proxy_hide_header X-AspNetMvc-Version;
{% endif %}
    }
    
{% if item.health_check is defined %}
    # Service-specific health check endpoint (no auth required)
    location {{ item.health_check }} {
        access_log off;
        proxy_pass http://{{ item.backend_host }}:{{ item.backend_port }}{{ item.health_check }};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
{% endif %}
    
    # Generic health check endpoint (no auth required)
    location /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }
    
{% if proxy_mode == 'traditional' and traditional_proxy_config.enable_status_page | default(false) %}
    # Status page for monitoring (restricted)
    location /nginx_status {
        stub_status on;
        access_log off;
        {% if item.monitoring_ips is defined %}
        {% for ip in item.monitoring_ips %}
        allow {{ ip }};
        {% endfor %}
        {% else %}
        allow 127.0.0.1;
        {% endif %}
        deny all;
    }
{% endif %}
    
    # Logging configuration
{% if proxy_mode == 'traditional' and not traditional_proxy_config.enable_access_logs | default(true) %}
    access_log off;
{% else %}
    access_log /var/log/nginx/{{ item.domain }}.access.log;
{% endif %}
    
{% if proxy_mode == 'traditional' and not traditional_proxy_config.enable_error_logs | default(true) %}
    error_log /dev/null;
{% else %}
    error_log /var/log/nginx/{{ item.domain }}.error.log;
{% endif %}
}

# HTTP redirect to HTTPS
server {
    listen 80;
    server_name {{ item.domain }};
    
{% if proxy_mode == 'traditional' and item.allow_http | default(false) %}
    # HTTP allowed for traditional proxy (if configured)
    location / {
        proxy_pass http://{{ item.backend_host }}:{{ item.backend_port }};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
{% else %}
    # Force HTTPS redirect
    return 301 https://$server_name$request_uri;
{% endif %}
}
