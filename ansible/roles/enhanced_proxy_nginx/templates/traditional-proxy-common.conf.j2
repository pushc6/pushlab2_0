# {{ ansible_managed }}
# Traditional Proxy Common Configuration
# This file contains shared configuration for traditional proxy mode

# Proxy cache configuration (if enabled)
{% if traditional_proxy_config.enable_caching | default(false) %}
proxy_cache_path /var/cache/nginx/proxy levels=1:2 keys_zone=proxy_cache_zone:10m max_size=1g inactive=60m use_temp_path=off;
proxy_cache_key "$scheme$request_method$host$request_uri";
proxy_cache_methods GET HEAD POST;
proxy_cache_min_uses 2;
{% endif %}

# Rate limiting configuration (if enabled)
{% if traditional_proxy_config.enable_rate_limiting | default(false) %}
limit_req_zone $binary_remote_addr zone=proxy_limit:10m rate={{ traditional_proxy_config.rate_limit | default('10r/s') }};
limit_req_status 429;
{% endif %}

# Upstream keepalive configuration
upstream_keepalive_timeout 60s;
keepalive_requests 100;
keepalive_timeout 60s;

# Buffer configuration
proxy_buffers 8 16k;
proxy_buffer_size 32k;
proxy_busy_buffers_size 32k;
proxy_temp_file_write_size 64k;

# Timeout configuration defaults
proxy_connect_timeout {{ traditional_proxy_config.proxy_timeout | default('60s') }};
proxy_send_timeout {{ traditional_proxy_config.proxy_timeout | default('60s') }};
proxy_read_timeout {{ traditional_proxy_config.proxy_timeout | default('60s') }};

# Request size limits
client_max_body_size {{ traditional_proxy_config.client_max_body_size | default('100M') }};
client_body_buffer_size 128k;

# Proxy headers configuration
proxy_set_header Accept-Encoding "";
proxy_set_header X-Forwarded-Server $host;
proxy_set_header X-Forwarded-Host $host;

# Hide backend server information
proxy_hide_header X-Powered-By;
proxy_hide_header Server;
proxy_hide_header X-Runtime;
proxy_hide_header X-Version;

# Error handling
proxy_intercept_errors on;
proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
proxy_next_upstream_tries 3;
proxy_next_upstream_timeout 30s;

# Custom error pages (optional)
{% if traditional_proxy_config.custom_error_pages | default(false) %}
error_page 404 /404.html;
error_page 500 502 503 504 /50x.html;
location = /404.html {
    root /usr/share/nginx/html;
    internal;
}
location = /50x.html {
    root /usr/share/nginx/html;
    internal;
}
{% endif %}

# Gzip configuration (if enabled)
{% if traditional_proxy_config.enable_gzip | default(true) %}
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/xml+rss
    application/rss+xml
    application/atom+xml
    image/svg+xml
    text/javascript
    application/x-font-ttf
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/font-woff
    font/opentype;
gzip_disable "msie6";
gzip_min_length 1000;
{% endif %}

# Security headers for traditional proxy
add_header X-Content-Type-Options nosniff always;
add_header X-Frame-Options SAMEORIGIN always;
add_header X-XSS-Protection "1; mode=block" always;

# Log format for traditional proxy
log_format proxy_combined '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          'rt=$request_time uct="$upstream_connect_time" '
                          'uht="$upstream_header_time" urt="$upstream_response_time" '
                          'cs=$upstream_cache_status';
