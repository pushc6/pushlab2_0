---
# roles/oauth2_proxy_nginx/tasks/selinux_config.yml
# Automatic SELinux configuration for OAuth2 backend ports

- name: Check if SELinux is enabled
  command: getenforce
  register: selinux_status
  changed_when: false
  failed_when: false

- name: Configure SELinux for OAuth2 backend ports
  block:
    - name: Install SELinux management tools
      package:
        name:
          - policycoreutils-python-utils
        state: present
      when: ansible_distribution_major_version|int >= 8

    - name: Install SELinux management tools (RHEL 7)
      package:
        name:
          - policycoreutils-python
        state: present
      when: ansible_distribution_major_version|int == 7

    - name: Enable httpd network connections
      seboolean:
        name: httpd_can_network_connect
        state: yes
        persistent: yes
      
    - name: Enable httpd network relay (additional permission)
      seboolean:
        name: httpd_can_network_relay
        state: yes
        persistent: yes
      ignore_errors: yes  # This boolean may not exist on all systems
    
    - name: Extract unique backend ports from OAuth2 services
      set_fact:
        oauth2_backend_ports: "{{ filtered_oauth2_services | map(attribute='backend_port') | list | unique | map('int') | list }}"
    
    - name: Display backend ports being configured
      debug:
        msg: 
          - "Configuring SELinux for backend ports: {{ oauth2_backend_ports }}"
          - "Services: {{ filtered_oauth2_services | map(attribute='name') | list }}"
    
    - name: Add backend ports to SELinux http_port_t context
      seport:
        ports: "{{ item }}"
        proto: tcp
        setype: http_port_t
        state: present
      register: selinux_port_result
      failed_when: 
        - selinux_port_result.failed
        - "'already defined' not in selinux_port_result.msg|default('')"
      loop: "{{ oauth2_backend_ports }}"
    
    - name: Verify SELinux port configuration
      command: semanage port -l | grep -E "http_port_t.*tcp.*{{ item }}"
      register: port_verification
      changed_when: false
      failed_when: false
      loop: "{{ oauth2_backend_ports }}"
    
    - name: Display SELinux port verification results
      debug:
        msg:
          - "Port {{ item.item }}: {{ 'CONFIGURED âœ…' if item.rc == 0 else 'CHECK NEEDED âš ï¸' }}"
      loop: "{{ port_verification.results }}"

    - name: Display SELinux configuration summary
      debug:
        msg:
          - "ğŸ”’ SELinux Configuration Complete"
          - "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          - "httpd_can_network_connect: âœ… Enabled"
          - "httpd_can_network_relay: âœ… Enabled"
          - "Backend ports configured: {{ oauth2_backend_ports | join(', ') }}"
          - "Services ready: {{ filtered_oauth2_services | map(attribute='name') | list | join(', ') }}"

  when: 
    - selinux_status.rc == 0
    - selinux_status.stdout != "Disabled"
    - ansible_os_family == "RedHat"

- name: SELinux disabled notification
  debug:
    msg: "SELinux is disabled - skipping SELinux configuration"
  when: 
    - selinux_status.rc == 0
    - selinux_status.stdout == "Disabled"
