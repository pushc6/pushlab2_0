---
# group_vars/nginx_internal/oauth2_vars_enhanced.yml
# Enhanced OAuth2-Proxy Configuration with Modular Components

# OAuth2-Proxy server settings
oauth2_proxy_host: "sso.push-lab.com"
oauth2_proxy_port: "4180"

# Debug mode for troubleshooting
oauth2_debug_mode: false

# SELinux Configuration
selinux_config:
  auto_configure: true          # Automatically configure SELinux during deployment
  install_tools: true           # Install SELinux management tools if missing
  configure_booleans: true      # Enable httpd_can_network_connect and httpd_can_network_relay
  configure_ports: true         # Add backend ports to http_port_t context
  verify_config: true           # Verify configuration after applying changes
  force_reconfigure: false      # Force reconfiguration even if already configured
  skip_on_disabled: true        # Skip SELinux config if SELinux is disabled

# Enhanced SSL Certificate definitions with security options
ssl_certificates:
  push-lab.com:
    cert_path: "/etc/nginx/ssl/push-lab.com/push-lab.com.fullchain.cer"
    key_path: "/etc/nginx/ssl/push-lab.com/push-lab.com.key"
    dhparam_path: "/etc/nginx/ssl/push-lab.com/dhparams.pem"

# Modular SSL Security Configuration
ssl_security_config:
  protocols: "TLSv1.2 TLSv1.3"
  ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
  prefer_server_ciphers: "off"
  session_timeout: "1d"
  session_tickets: "off"
  stapling_enabled: true
  resolver: "8.8.8.8 8.8.4.4"
  resolver_timeout: "5s"

# Security Headers Configuration (modular)
security_headers:
  hsts_max_age: "63072000"
  hsts_preload: true
  x_frame_options: "DENY"
  x_content_type_options: "nosniff"
  x_xss_protection: "1; mode=block"
  referrer_policy: "strict-origin-when-cross-origin"

# Logout Configuration (modular)
logout_config:
  enable_id_token_logout: true
  enable_sso_logout: true
  enable_force_logout: true
  enable_logout_success_page: true
  keycloak_realm: "prod"
  keycloak_client_id: "oauth2-proxy-multi-domain"
  logout_success_redirect: true

# OAuth2 Service definitions (enhanced with metadata)
oauth2_services:
  - name: "sonarr"
    domain: "sonarr.push-lab.com"
    backend_host: "10.37.70.7"
    backend_port: "8989"
    auth_type: "simple"
    ssl_domain: "push-lab.com"
    description: "Sonarr TV Series Management"
    category: "media"
    health_check: "/ping"
    
  - name: "radarr"
    domain: "radarr.push-lab.com"
    backend_host: "10.37.70.7"
    backend_port: "7878"
    auth_type: "simple"
    ssl_domain: "push-lab.com"
    description: "Radarr Movie Management"
    category: "media"
    health_check: "/ping"
  
  - name: "code"
    domain: "code.push-lab.com"
    backend_host: "10.37.70.7"
    backend_port: "8443"
    auth_type: "simple"
    ssl_domain: "push-lab.com"
    description: "VS Code"
    category: "code"
    health_check: "/ping"    

  - name: "dashboard"
    domain: "dashboard.push-lab.com"
    backend_host: "10.37.70.7"
    backend_port: "3002"
    auth_type: "none"
    ssl_domain: "push-lab.com"
    description: "Homelab Dashboard"
    category: "dashboard"
    health_check: "/ping"

  - name: "lidarr"
    domain: "lidarr.push-lab.com"
    backend_host: "10.37.70.7"
    backend_port: "8686"
    auth_type: "simple"
    ssl_domain: "push-lab.com"
    description: "Radarr Movie Management"
    category: "media"
    health_check: "/ping"

  - name: "dozzle"
    domain: "dozzle.push-lab.com"
    backend_host: "10.37.70.7"
    backend_port: "9999"
    auth_type: "simple"
    ssl_domain: "push-lab.com"
    description: "Dozzle log aggregation"
    category: "logs"
    health_check: "/ping"

  - name: "sab"
    domain: "sab.push-lab.com"
    backend_host: "10.37.70.7"
    backend_port: "8085"
    auth_type: "simple"
    ssl_domain: "push-lab.com"
    description: "SABNZBd"
    category: "usenet"
    health_check: "/ping"

  - name: "truenas"
    domain: "truenas.push-lab.com"
    backend_host: "10.37.70.22"
    backend_port: "80"
    auth_type: "simple"
    ssl_domain: "push-lab.com"
    description: "TrueNAS"
    category: "nas"
    health_check: "/ping"

  - name: "zwave"
    domain: "zwave.push-lab.com"
    backend_host: "10.37.50.12"
    backend_port: "8091"
    auth_type: "simple"
    ssl_domain: "push-lab.com"
    description: "Zwave Manager"
    category: "smarthome"
    health_check: "/ping"

  - name: "zigbee"
    domain: "zigbee.push-lab.com"
    backend_host: "10.37.50.12"
    backend_port: "8080"
    auth_type: "simple"
    ssl_domain: "push-lab.com"
    description: "Zwave Manager"
    category: "smarthome"
    health_check: "/ping"


  - name: "synology"
    domain: "synology.push-lab.com"
    backend_host: "10.37.20.4"
    backend_port: "5000"
    auth_type: "simple"
    ssl_domain: "push-lab.com"
    description: "Synology"
    category: "media"
    health_check: "/ping"

#  - name: "grafana"
#    domain: "grafana.push-lab.com"
#    backend_host: "10.37.70.10"
#    backend_port: "3000"
#    auth_type: "roles"
#    required_roles: 
#      - "grafana:admin"
#      - "monitoring:viewer"
#    ssl_domain: "push-lab.com"
#    description: "Grafana Monitoring Dashboard"
#    category: "monitoring"
#    health_check: "/api/health"
#    custom_headers:
#      X-Service-Type: "monitoring"
#      X-Environment: "production"

# Nginx proxy settings (modular)
nginx_config:
  proxy_timeout: "60s"
  client_max_body_size: "100M"
  proxy_buffering: "off"
  proxy_request_buffering: "off"
  proxy_http_version: "1.1"
  keepalive_timeout: "65s"
  send_timeout: "60s"
  read_timeout: "60s"

# Rate limiting configuration (optional)
rate_limiting:
  enabled: false
  zone_name: "oauth2_limit"
  zone_size: "10m"
  rate: "10r/m"
  burst: "20"
  nodelay: true

# Monitoring and alerting (optional)
monitoring:
  access_log_format: "oauth2_combined"
  error_log_level: "warn"
  enable_metrics: false
  metrics_endpoint: "/nginx_status"

# Backup and maintenance
maintenance:
  backup_enabled: true
  backup_retention_days: 30
  config_validation: true
  auto_reload: true

# Optional: Default authentication settings (backwards compatibility)
default_auth_type: "simple"
default_ssl_domain: "push-lab.com"
