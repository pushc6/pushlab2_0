# AlmaLinux 10 on vSphere — IaC Project

This repo manages a full image lifecycle with IaC:

- packer/: builds the minimal AlmaLinux 10 template in vSphere
- terraform/: clones a VM from the template, adds optional data disk, mounts it
- ansible/: configuration management and bootstrap tasks

## Layout

- packer/
  - alma-template.pkr.hcl
  - http/ (kickstarts)
  - scripts/ (build/cleanup/validate)
  - cloud-init/ (optional)
- terraform/
  - main.tf, variables.tf, outputs.tf, terraform.tfvars
- ansible/
  - inventory.ini, site.yml

## Typical flow

1) Build/update the vSphere template with Packer

```
cd packer
packer init .

# Provide secrets via var-file (not committed)
# Push Lab 2.0 — AlmaLinux 10 + Gitea on vSphere

End-to-end IaC to build an AlmaLinux 10 template with Packer, deploy a VM on vSphere using Terraform with cloud-init network v2 for a static IP, and configure Gitea via Ansible (including secure admin creation, internal SSH on 2222, and integration notes for a reverse proxy and 1Password SSH Agent).

## What this repo does

- Packer: Builds a vSphere AlmaLinux 10 template with cloud-init and open-vm-tools.
- Terraform: Clones a VM from that template, injects cloud-init (VMware datasource) with network v2 metadata for a static IP, attaches and mounts a data disk for Gitea, and emits an Ansible inventory.
- Ansible: Installs and configures Gitea, templating `app.ini`, enabling internal SSH on port 2222, opening firewall rules, and creating an admin user from secrets in host_vars.
- Git workflow: Single remote with multiple push URLs to push to GitHub and Gitea in one command.

## Architecture

- Environment: vSphere
  - vCenter: 10.37.10.35
  - Datacenter: Push Datacenter
  - Cluster: Lab Cluster
  - Datastore: ssd-local
  - Network: VLAN 80 - App
- VM (Gitea):
  - OS: AlmaLinux 10
  - Static IP: 10.37.80.4/24 via cloud-init network v2 (gateway 10.37.80.1)
  - DNS: 10.37.80.2, domain: localdomain
  - Data disk mounted under `/var/lib/gitea`
  - Gitea HTTP: 3000 (behind reverse proxy optional)
  - Gitea internal SSH: 2222 (tcp)
- DNS
  - git.push-lab.com (preferred external name)
  - If using a reverse proxy at 10.37.70.24: forward TCP/2222 to 10.37.80.4:2222

## Prerequisites

- Packer
- Terraform (+ vSphere provider)
- Ansible (core 2.15+ recommended)
- macOS with zsh (your environment)
- Access to vCenter and the vSphere resources listed above
- 1Password (if using the SSH Agent to manage Git keys)

## Packer — build template

Builds an AlmaLinux 10 template with: cloud-init (VMware datasource), open-vm-tools, basic hardening, and cleanup.

- Template name (example): `almalinux-10-ci-template-20251104-fresh`
- Output: vSphere template ready for Terraform cloning

Commands and HCL files live under `packer/` (not reproduced here). Update vCenter credentials and builder settings as needed.

## Terraform — deploy VM

The module:
- Clones from the template
- Sets `guestinfo.metadata` and `guestinfo.userdata` to feed cloud-init
- Uses cloud-init network v2 for reliable static IP (no vSphere guest customization)
- Mounts a data disk for Gitea
- Generates an Ansible inventory for the VM

Key points:
- Cloud-init network v2 is injected in `extra_config` (guestinfo).
- vsphere customization is disabled when `use_cloud_init = true`.
- Ansible inventory emitted to `ansible/inventories/prod/hosts.yml`.

Typical workflow (set your tfvars and provider details):

```sh
# From repo root
terraform init
terraform plan -var-file=env/prod.tfvars
terraform apply -var-file=env/prod.tfvars
```

Expected result: a VM at 10.37.80.4 with cloud-init applying the static IP.

## Ansible — configure Gitea

Inventory and roles:
- Inventory: `ansible/inventories/prod/hosts.yml` (generated by Terraform)
- Role: `ansible/roles/gitea`

What the role does:
- Installs Gitea binary and systemd unit
- Renders `/etc/gitea/app.ini` (owner: `git:git`, mode `0660`)
- Enables internal SSH server on port 2222 and opens firewalld for 2222/tcp
- Starts and enables `gitea` service
- Creates an admin user via `gitea` CLI with `--work-path /var/lib/gitea`
 - Optional: Installs a Gitea Actions runner (Docker-based by default)

Run:

```sh
ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i ansible/inventories/prod/hosts.yml ansible/site.yml
```

Health checks:
- HTTP: `http://10.37.80.4:3000/` should return 200.
- SSH banner: `ssh -T -p 2222 git@10.37.80.4` should show Gitea’s “no shell access” greeting.

### Gitea Actions runner (Docker)

If you provide a registration token, the role will:
- Install Docker Engine
- Register a runner against `gitea_external_url`
- Start the runner as a Docker container with systemd

Variables (set in host_vars, e.g. `ansible/inventories/prod/host_vars/gitea/secrets.yml`):
- `gitea_runner_registration_token`: required to register the runner
- `gitea_runner_use_docker`: true (default)
- `gitea_runner_name`: defaults to `runner-<inventory_hostname>`
- `gitea_runner_labels`: defaults to `[self-hosted, linux, x64]`

Runner data dir: `/opt/gitea-runner` (bind mounted into the container). The registration step creates `/opt/gitea-runner/config.yaml`. The service unit runs:

```
docker run --name gitea-runner --rm \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /opt/gitea-runner:/data \
  gitea/act_runner:latest --config /data/config.yaml daemon
```

## Secrets and admin user

Store admin credentials in host_vars, e.g.:

- `ansible/inventories/prod/host_vars/gitea/secrets.yml`
  - `gitea_admin_username: giteaadmin`
  - `gitea_admin_password: <your-strong-password>`
  - `gitea_admin_email: you@example.com`

These files are ignored by `.gitignore` and not committed. The role creates the admin user idempotently.

## Gitea SSH (internal 2222) and DNS/proxy

- Gitea runs its own SSH server on 2222 (non-root-friendly and independent of system sshd).
- app.ini template sets:
  - `START_SSH_SERVER = true`
  - `SSH_LISTEN_HOST = 0.0.0.0`
  - `SSH_LISTEN_PORT = 2222`
  - `SSH_PORT = 2222` and `SSH_DOMAIN = git.push-lab.com` (for correct clone URLs)

If using a reverse proxy at 10.37.70.24:
- Keep `git.push-lab.com` pointing to the proxy
- Add a TCP forward for 2222/tcp → 10.37.80.4:2222
- Alternatives:
  - Use a separate DNS just for SSH (e.g., `git-ssh.push-lab.com` → 10.37.80.4)
  - Or have the proxy listen on 22 and forward to 10.37.80.4:2222 (if you relocate proxy’s admin ssh)

Examples:
- NGINX (stream):

```nginx
stream {
  upstream gitea_ssh { server 10.37.80.4:2222; }
  server {
    listen 2222;
    proxy_pass gitea_ssh;
    proxy_connect_timeout 5s;
    proxy_timeout 300s;
  }
}
```

- HAProxy:

```haproxy
frontend gitea_ssh
  bind *:2222
  mode tcp
  default_backend gitea_ssh_backend

backend gitea_ssh_backend
  mode tcp
  option tcp-check
  server gitea 10.37.80.4:2222 check
```

- Traefik (v2):

```yaml
# static
entryPoints:
  ssh:
    address: ":2222"

# dynamic (file provider)
tcp:
  routers:
    gitea-ssh:
      entryPoints: ["ssh"]
      rule: "HostSNI(`*`)"
      service: gitea-ssh-svc
  services:
    gitea-ssh-svc:
      loadBalancer:
        servers:
          - address: "10.37.80.4:2222"
```

Validation:

```sh
nc -vz git.push-lab.com 2222
ssh -T -p 2222 git@git.push-lab.com
```

## 1Password SSH Agent notes

- Ensure the 1Password SSH Agent is enabled and your key is allowed for the host.
- On macOS, you typically don’t need a manual symlink; use `IdentityAgent` in `~/.ssh/config` or rely on the default agent integration.
- Verify with:

```sh
ssh-add -L
ssh -T -p 2222 git@10.37.80.4
```

If you see the Gitea banner, the agent is offering a matching key.

## Git multi-remote push

Keep a single remote with multiple push URLs so a single `git push` updates GitHub and Gitea:

```sh
git remote set-url --add --push origin git@github.com:pushc6/pushlab2_0.git
git remote set-url --add --push origin ssh://git@git.push-lab.com:2222/push/push-lab_2_0.git

git remote -v  # should show fetch URL once and two push URLs
```

Push as usual:

```sh
git push origin main --tags
```

## Troubleshooting

- Static IP not applied:
  - Confirm cloud-init VMware datasource sees `guestinfo.metadata` and `metadata.network` (network v2)
  - Check `/var/log/cloud-init.log` and `/var/log/cloud-init-output.log`
- Gitea not starting:
  - Ensure `/etc/gitea/app.ini` is `git:git` and `0660`
  - `journalctl -u gitea --no-pager -n 200`
- SSH to 2222 refused via DNS:
  - Confirm DNS for `git.push-lab.com`
  - If using a proxy, ensure TCP forward 2222 → 10.37.80.4:2222
  - Test direct IP: `nc -vz 10.37.80.4 2222`
- Admin user missing:
  - Ensure host_vars secrets are present and Ansible ran the admin creation task
  - Gitea CLI in role uses `--work-path /var/lib/gitea`

## Maintenance

- Rebuild template with Packer when base OS or agents change
- Terraform taint/replace to redeploy VM if template updates are required
- Ansible is idempotent; re-run to update Gitea config, ports, or admin setup

## Notes

- The repo intentionally ignores secrets under inventory `host_vars`/`group_vars` via `.gitignore`.
- Values like IP/DNS above match the current lab setup; adjust to your environment as needed.
