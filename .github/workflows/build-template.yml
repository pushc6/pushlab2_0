name: Build AlmaLinux Template

on:
  push:
    branches: [ main ]
    paths:
      - 'packer/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      template_version:
        description: 'Template version tag'
        required: true
        default: 'v1.0.0'

env:
  PACKER_VERSION: "1.10.0"

jobs:
  build-template:
    runs-on: ubuntu-latest
    name: Build AlmaLinux 10 Template
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: ${{ env.PACKER_VERSION }}

    - name: Initialize Packer
      working-directory: packer
      run: packer init alma-template.pkr.hcl

    - name: Validate Packer template
      working-directory: packer
      run: packer validate alma-template.pkr.hcl

    - name: Build template
      working-directory: packer
      run: |
        packer build \
          -var "vcenter_server=${{ secrets.VCENTER_SERVER }}" \
          -var "vcenter_username=${{ secrets.VCENTER_USERNAME }}" \
          -var "vcenter_password=${{ secrets.VCENTER_PASSWORD }}" \
          -var "template_name=almalinux-10-minimal-${{ github.run_number }}" \
          alma-template.pkr.hcl
      env:
        PACKER_LOG: 1

    - name: Tag template version
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "Template built with version: ${{ github.event.inputs.template_version }}"
        # Additional tagging logic could go here

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: packer-logs
        path: |
          packer/*.log
          packer/packer-manifest.json

  notify:
    needs: build-template
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Notify build status
      run: |
        if [ "${{ needs.build-template.result }}" == "success" ]; then
          echo "✅ Template build completed successfully"
        else
          echo "❌ Template build failed"
          exit 1
        fi
